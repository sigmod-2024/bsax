#include "sax.h"
#include <vector>
#include <unordered_map>
#include <unordered_set>
#include <iostream>
using namespace std;

unordered_map<string, long> mp;
void FinsSAX(const char *sax_filename) {
    FILE * data_file = fopen(sax_filename,"r");
    if (!data_file) {
        cout << "" << sax_filename << endl;
        exit(-1);
    }
    vector<SAX> sax_vec(TOTAL_TS);

    for(int i = 0; i < TOTAL_TS; i++) {
        bool flag = true;
        fread(&sax_vec[i], sizeof(SAX), 1, data_file);
        string str;
        for (int j = 0; j < SEGMENTS; j ++ ) {
            str += to_string(sax_vec[i].sax[j]);
            str += ", ";
        }
        mp[str] ++;
        if ((i + 1) % 1000000 == 0) {
            cout << i + 1 << endl;
        }
    }
    int cnt = 0, all_cnt = 0;
    for (auto& s: mp) {
        if (s.second >= 100) {
            cnt ++;
            cout << s.first << endl;
            all_cnt += s.second;
        }
    }
    cout << cnt << " "  << all_cnt << endl;
    fclose (data_file);
}


//184
//285
//201
//155
//115
//103
//172
//116
//172

// 603

// 85 33812
const int deep_sax_len = 85;
static SAX deep_sax[deep_sax_len] = {173, 28, 51, 120, 154, 134, 20, 49, 106, 79, 85, 201, 43, 103, 97, 138, 229, 70, 119, 90, 227, 65, 24, 186, 167, 191, 205, 140, 167, 128, 117, 116,
                          149, 44, 43, 132, 200, 50, 61, 19, 74, 82, 59, 141, 54, 137, 103, 187, 215, 93, 138, 125, 183, 61, 50, 134, 164, 161, 226, 172, 105, 143, 176, 89,
                          203, 167, 47, 61, 185, 43, 66, 8, 97, 175, 162, 115, 48, 115, 180, 57, 150, 74, 86, 178, 165, 30, 74, 202, 208, 183, 158, 77, 140, 150, 115, 96,
                          157, 22, 70, 105, 143, 131, 40, 32, 92, 83, 61, 189, 36, 116, 76, 171, 229, 106, 146, 100, 208, 58, 52, 180, 198, 179, 199, 149, 178, 114, 114, 122,
                          199, 38, 48, 110, 149, 131, 17, 32, 134, 59, 110, 216, 38, 104, 103, 139, 219, 58, 108, 104, 227, 79, 28, 193, 169, 169, 213, 140, 160, 107, 140, 102,
                          102, 199, 99, 138, 125, 216, 51, 147, 78, 163, 102, 187, 156, 98, 44, 178, 190, 115, 121, 107, 92, 206, 145, 116, 225, 164, 221, 41, 96, 66, 183, 61,
                          148, 118, 199, 110, 160, 149, 215, 165, 61, 184, 135, 195, 234, 143, 115, 60, 126, 88, 93, 49, 38, 139, 97, 136, 114, 94, 211, 118, 44, 73, 171, 157,
                          222, 64, 34, 138, 133, 89, 73, 202, 119, 92, 103, 130, 35, 125, 138, 117, 87, 130, 51, 118, 31, 102, 92, 87, 32, 107, 175, 143, 102, 167, 92, 209,
                          155, 180, 74, 89, 172, 43, 65, 8, 106, 158, 179, 80, 66, 95, 176, 71, 138, 114, 93, 194, 178, 42, 92, 226, 194, 161, 163, 116, 143, 174, 84, 74,
                          78, 26, 63, 120, 158, 85, 93, 85, 156, 14, 29, 80, 140, 182, 148, 126, 93, 194, 167, 101, 217, 65, 90, 90, 133, 123, 221, 180, 134, 229, 124, 145,
                          67, 75, 108, 110, 214, 142, 221, 173, 44, 88, 147, 198, 115, 91, 70, 232, 111, 179, 124, 195, 219, 201, 48, 171, 168, 91, 134, 178, 160, 151, 36, 173,
                          110, 194, 79, 143, 131, 224, 46, 141, 66, 155, 100, 189, 148, 103, 57, 178, 197, 107, 134, 108, 91, 216, 142, 119, 222, 175, 220, 39, 85, 72, 190, 66,
                          205, 82, 119, 99, 195, 25, 86, 98, 99, 152, 123, 145, 63, 169, 170, 163, 227, 121, 138, 162, 193, 37, 76, 170, 96, 155, 201, 153, 145, 109, 173, 44,
                          105, 219, 147, 189, 209, 105, 217, 138, 134, 168, 105, 158, 191, 126, 225, 115, 48, 138, 159, 115, 155, 214, 122, 114, 137, 101, 90, 205, 164, 108, 91, 114,
                          230, 175, 47, 57, 199, 94, 71, 17, 101, 186, 113, 152, 59, 110, 188, 44, 158, 36, 98, 165, 158, 42, 83, 169, 190, 189, 105, 65, 119, 107, 159, 132,
                          140, 19, 76, 109, 147, 129, 41, 33, 99, 78, 58, 164, 27, 130, 84, 183, 231, 111, 149, 81, 209, 67, 56, 183, 206, 160, 192, 159, 183, 107, 130, 116,
                          102, 199, 99, 138, 126, 214, 52, 147, 78, 163, 102, 187, 158, 97, 44, 177, 190, 114, 121, 108, 91, 204, 144, 117, 226, 165, 222, 40, 94, 66, 183, 61,
                          155, 180, 75, 88, 172, 43, 66, 8, 105, 158, 179, 80, 66, 95, 175, 71, 139, 114, 93, 194, 178, 42, 92, 226, 194, 162, 163, 116, 143, 175, 84, 75,
                          97, 68, 136, 165, 171, 127, 102, 114, 136, 124, 186, 38, 145, 97, 51, 181, 84, 185, 220, 164, 29, 148, 74, 16, 180, 112, 164, 131, 122, 77, 150, 108,
                          201, 119, 42, 60, 128, 69, 29, 39, 94, 209, 158, 128, 67, 96, 165, 39, 133, 119, 50, 191, 166, 86, 89, 198, 144, 163, 91, 46, 92, 137, 115, 83,
                          113, 100, 7, 85, 86, 86, 131, 81, 123, 174, 116, 132, 84, 157, 121, 150, 158, 77, 64, 79, 72, 129, 229, 199, 92, 197, 183, 160, 72, 205, 226, 100,
                          196, 168, 54, 157, 212, 65, 126, 90, 91, 155, 96, 115, 57, 97, 174, 182, 52, 165, 40, 181, 88, 169, 121, 96, 40, 195, 130, 135, 82, 172, 73, 132,
                          147, 100, 42, 159, 154, 62, 112, 182, 112, 119, 88, 109, 76, 184, 156, 87, 72, 121, 62, 224, 92, 105, 166, 109, 56, 122, 60, 93, 29, 222, 100, 194,
                          153, 11, 155, 190, 103, 204, 41, 139, 69, 143, 93, 80, 138, 178, 178, 164, 69, 120, 198, 183, 81, 149, 115, 146, 38, 112, 192, 140, 107, 73, 161, 121,
                          177, 141, 55, 72, 141, 49, 31, 24, 97, 188, 180, 106, 66, 96, 157, 46, 140, 126, 48, 189, 162, 72, 88, 218, 155, 170, 115, 62, 98, 157, 87, 71,
                          199, 95, 39, 64, 141, 135, 34, 89, 97, 210, 129, 143, 79, 105, 154, 31, 143, 140, 54, 182, 156, 137, 98, 168, 111, 161, 77, 43, 69, 104, 122, 130,
                          226, 201, 58, 33, 188, 154, 73, 24, 75, 170, 121, 158, 56, 85, 159, 62, 133, 58, 76, 177, 182, 50, 87, 179, 184, 168, 113, 92, 102, 95, 144, 159,
                          230, 145, 81, 93, 150, 66, 87, 94, 84, 97, 105, 143, 22, 122, 100, 153, 222, 125, 125, 152, 234, 27, 92, 163, 94, 183, 170, 109, 109, 182, 135, 128,
                          107, 198, 81, 140, 118, 220, 37, 142, 74, 157, 100, 186, 148, 97, 52, 169, 203, 98, 121, 124, 93, 217, 134, 125, 224, 179, 220, 43, 88, 73, 182, 66,
                          165, 94, 51, 74, 56, 39, 121, 232, 63, 63, 213, 28, 59, 94, 184, 110, 114, 83, 194, 83, 57, 230, 123, 126, 62, 130, 208, 128, 97, 188, 189, 83,
                          171, 30, 48, 115, 148, 139, 21, 46, 101, 79, 78, 203, 47, 99, 93, 128, 227, 66, 112, 88, 223, 67, 23, 181, 168, 196, 210, 136, 163, 135, 116, 123,
                          193, 53, 77, 68, 91, 120, 3, 53, 208, 86, 153, 156, 72, 109, 132, 140, 232, 83, 70, 63, 208, 103, 46, 203, 123, 167, 157, 110, 173, 131, 92, 139,
                          104, 196, 88, 141, 134, 224, 39, 141, 68, 151, 98, 198, 151, 95, 56, 179, 200, 115, 132, 114, 92, 212, 140, 128, 222, 172, 223, 38, 92, 73, 190, 67,
                          189, 132, 50, 66, 134, 55, 28, 28, 95, 195, 172, 112, 66, 94, 160, 45, 137, 119, 49, 192, 164, 75, 89, 212, 153, 169, 104, 54, 94, 148, 100, 73,
                          104, 104, 116, 144, 150, 44, 91, 17, 140, 124, 137, 163, 136, 79, 70, 107, 175, 139, 71, 112, 191, 74, 106, 118, 149, 196, 202, 203, 149, 198, 132, 82,
                          106, 199, 81, 139, 117, 220, 38, 142, 73, 157, 102, 186, 148, 98, 52, 169, 204, 96, 121, 124, 92, 217, 135, 125, 224, 180, 221, 43, 87, 75, 183, 67,
                          179, 32, 46, 110, 150, 126, 17, 48, 109, 73, 92, 206, 47, 97, 103, 121, 224, 68, 112, 95, 227, 63, 19, 192, 161, 196, 208, 135, 162, 138, 127, 114,
                          144, 120, 83, 150, 172, 56, 100, 44, 117, 137, 114, 187, 55, 95, 95, 171, 229, 116, 88, 167, 175, 44, 115, 157, 134, 210, 184, 214, 147, 224, 143, 122,
                          193, 180, 63, 58, 182, 58, 60, 9, 86, 183, 148, 112, 54, 90, 182, 61, 138, 78, 97, 191, 183, 32, 81, 211, 191, 166, 138, 92, 145, 153, 120, 84,
                          135, 175, 69, 86, 195, 34, 54, 11, 155, 168, 189, 99, 89, 118, 165, 99, 182, 83, 71, 149, 123, 129, 101, 232, 213, 147, 131, 113, 130, 124, 73, 48,
                          192, 34, 177, 151, 132, 90, 96, 47, 80, 85, 124, 156, 70, 128, 239, 180, 237, 125, 95, 134, 240, 114, 103, 83, 141, 149, 192, 237, 127, 218, 124, 187,
                          214, 79, 106, 167, 181, 84, 86, 71, 77, 155, 151, 145, 61, 119, 142, 163, 197, 57, 184, 212, 225, 35, 80, 143, 137, 170, 219, 196, 194, 163, 205, 68,
                          210, 86, 113, 169, 178, 77, 93, 89, 72, 150, 157, 143, 75, 109, 150, 164, 192, 58, 182, 226, 232, 39, 72, 155, 115, 164, 226, 204, 190, 172, 212, 76,
                          220, 157, 66, 36, 207, 152, 70, 25, 56, 191, 91, 140, 42, 78, 175, 54, 141, 50, 102, 173, 161, 43, 79, 173, 165, 182, 107, 72, 126, 110, 162, 154,
                          161, 47, 72, 97, 124, 124, 25, 38, 139, 77, 86, 227, 139, 58, 78, 134, 203, 117, 147, 127, 198, 75, 33, 194, 142, 136, 219, 132, 137, 196, 126, 140,
                          141, 197, 176, 199, 196, 102, 189, 94, 125, 153, 110, 215, 158, 143, 134, 152, 80, 175, 172, 67, 67, 210, 103, 91, 96, 81, 75, 209, 108, 148, 80, 89,
                          157, 163, 77, 91, 192, 37, 85, 9, 110, 159, 143, 93, 42, 116, 172, 67, 166, 58, 92, 201, 185, 39, 93, 220, 182, 142, 186, 136, 129, 157, 101, 77,
                          166, 180, 71, 77, 177, 47, 63, 7, 98, 165, 174, 88, 59, 95, 177, 66, 138, 105, 91, 193, 179, 37, 88, 223, 194, 168, 159, 110, 143, 170, 91, 79,
                          221, 157, 66, 37, 207, 152, 70, 25, 56, 191, 90, 140, 42, 79, 175, 54, 141, 49, 102, 172, 161, 43, 80, 173, 165, 182, 107, 72, 127, 109, 162, 154,
                          154, 158, 71, 88, 145, 32, 40, 17, 102, 163, 193, 85, 75, 89, 157, 65, 138, 124, 53, 186, 163, 61, 93, 227, 172, 161, 139, 85, 116, 174, 75, 62,
                          211, 161, 56, 58, 159, 56, 46, 14, 115, 163, 159, 121, 47, 126, 165, 62, 167, 56, 85, 191, 164, 39, 88, 229, 191, 162, 132, 81, 120, 123, 121, 130,
                          109, 97, 7, 98, 83, 95, 127, 80, 123, 176, 111, 137, 84, 159, 113, 149, 157, 76, 69, 82, 72, 126, 224, 200, 84, 209, 188, 151, 68, 208, 224, 103,
                          217, 168, 143, 45, 171, 35, 164, 61, 154, 57, 101, 148, 148, 73, 211, 132, 122, 135, 80, 95, 245, 150, 57, 88, 81, 165, 146, 112, 121, 165, 176, 152,
                          208, 105, 77, 90, 208, 63, 84, 31, 101, 173, 116, 144, 25, 129, 133, 125, 216, 57, 138, 185, 183, 21, 84, 185, 134, 185, 146, 147, 169, 148, 154, 110,
                          88, 70, 37, 81, 141, 123, 61, 142, 195, 60, 164, 124, 110, 180, 141, 198, 240, 100, 165, 66, 170, 75, 148, 163, 150, 136, 185, 129, 127, 75, 79, 142,
                          198, 37, 48, 105, 151, 133, 18, 34, 132, 60, 111, 217, 38, 104, 103, 135, 218, 57, 109, 107, 226, 80, 28, 194, 170, 169, 214, 139, 158, 106, 140, 102,
                          196, 37, 48, 104, 143, 136, 16, 35, 132, 60, 107, 218, 41, 101, 98, 138, 219, 58, 106, 101, 225, 80, 27, 193, 172, 169, 213, 140, 163, 108, 136, 107,
                          89, 198, 31, 160, 56, 97, 223, 122, 163, 42, 168, 140, 130, 160, 179, 197, 164, 121, 70, 142, 199, 172, 148, 210, 57, 75, 195, 162, 44, 169, 131, 185,
                          107, 79, 34, 131, 77, 146, 182, 131, 172, 51, 53, 189, 131, 178, 162, 71, 156, 63, 203, 49, 97, 89, 85, 101, 195, 48, 74, 53, 111, 71, 60, 178,
                          216, 171, 56, 42, 188, 86, 60, 12, 75, 188, 130, 135, 46, 86, 187, 60, 132, 58, 94, 186, 182, 31, 81, 198, 184, 174, 124, 79, 146, 138, 149, 111,
                          105, 197, 82, 144, 131, 224, 43, 135, 67, 153, 98, 195, 151, 100, 57, 180, 200, 111, 132, 108, 90, 211, 145, 122, 223, 175, 222, 40, 88, 76, 188, 66,
                          160, 153, 78, 81, 187, 33, 58, 9, 146, 174, 184, 108, 56, 102, 175, 87, 164, 93, 60, 160, 138, 102, 119, 214, 194, 138, 142, 101, 126, 134, 69, 55,
                          173, 145, 70, 105, 82, 169, 108, 227, 107, 76, 189, 127, 91, 115, 117, 130, 26, 109, 149, 142, 73, 175, 123, 146, 12, 177, 194, 57, 74, 120, 98, 55,
                          93, 212, 100, 138, 165, 205, 61, 111, 93, 141, 103, 126, 127, 159, 34, 160, 195, 71, 142, 72, 59, 220, 152, 72, 193, 129, 221, 86, 80, 66, 153, 73,
                          208, 105, 76, 88, 208, 63, 85, 30, 101, 173, 114, 144, 24, 127, 133, 122, 216, 58, 134, 185, 183, 21, 83, 185, 134, 185, 145, 145, 169, 148, 152, 110,
                          233, 140, 86, 91, 144, 63, 91, 100, 88, 94, 107, 145, 26, 121, 103, 153, 225, 124, 118, 150, 235, 27, 93, 164, 85, 186, 168, 109, 108, 180, 136, 130,
                          168, 116, 56, 80, 62, 223, 101, 30, 165, 51, 39, 210, 215, 79, 71, 136, 199, 131, 159, 93, 128, 108, 26, 167, 156, 237, 166, 219, 89, 81, 80, 80,
                          182, 179, 67, 68, 178, 49, 62, 9, 92, 175, 156, 105, 59, 90, 181, 64, 136, 89, 93, 191, 185, 34, 84, 214, 194, 162, 148, 100, 148, 162, 109, 78,
                          175, 181, 69, 70, 183, 54, 62, 7, 90, 170, 167, 93, 55, 92, 177, 62, 140, 96, 92, 196, 179, 35, 85, 220, 192, 174, 153, 103, 141, 165, 98, 83,
                          170, 179, 69, 77, 175, 46, 63, 8, 99, 167, 169, 92, 61, 93, 179, 68, 137, 100, 93, 194, 181, 38, 89, 221, 194, 162, 155, 108, 146, 168, 97, 78,
                          82, 214, 92, 120, 162, 189, 66, 111, 101, 152, 94, 121, 132, 153, 36, 154, 197, 72, 145, 91, 55, 210, 158, 66, 204, 133, 224, 79, 75, 68, 167, 64,
                          94, 47, 143, 152, 165, 114, 95, 61, 74, 41, 211, 151, 88, 66, 175, 168, 187, 154, 67, 106, 134, 130, 200, 205, 173, 67, 196, 109, 51, 160, 178, 223,
                          199, 38, 43, 99, 139, 137, 18, 32, 128, 60, 104, 219, 39, 102, 101, 137, 216, 58, 109, 111, 221, 76, 29, 189, 174, 170, 211, 139, 164, 111, 141, 107,
                          116, 77, 213, 155, 106, 64, 169, 84, 139, 149, 159, 104, 166, 118, 188, 166, 249, 61, 55, 136, 204, 82, 153, 117, 125, 109, 148, 205, 80, 187, 76, 182,
                          69, 75, 107, 109, 215, 142, 219, 174, 46, 90, 151, 198, 114, 86, 69, 233, 107, 180, 120, 196, 218, 201, 47, 173, 169, 93, 130, 179, 158, 152, 34, 177,
                          178, 33, 45, 114, 152, 127, 17, 51, 124, 69, 100, 207, 46, 103, 98, 124, 227, 71, 111, 85, 233, 64, 20, 191, 159, 192, 212, 151, 160, 131, 117, 110,
                          86, 155, 77, 192, 179, 185, 197, 169, 87, 123, 55, 166, 77, 86, 46, 225, 128, 159, 112, 123, 130, 110, 29, 167, 134, 84, 57, 102, 110, 45, 86, 216,
                          102, 193, 92, 140, 129, 219, 52, 147, 72, 165, 89, 185, 156, 102, 45, 179, 191, 122, 131, 108, 84, 206, 147, 106, 222, 164, 222, 41, 86, 63, 188, 66,
                          97, 44, 148, 149, 162, 108, 91, 62, 75, 39, 210, 147, 88, 66, 170, 164, 190, 158, 70, 105, 135, 130, 201, 205, 179, 64, 197, 111, 49, 161, 180, 222,
                          94, 40, 68, 125, 135, 50, 88, 82, 171, 17, 27, 58, 123, 180, 153, 140, 122, 188, 122, 85, 225, 83, 73, 92, 95, 156, 213, 207, 145, 215, 141, 125,
                          180, 32, 45, 106, 149, 126, 18, 49, 108, 72, 91, 208, 46, 100, 105, 120, 225, 69, 114, 94, 229, 63, 18, 193, 158, 198, 207, 137, 161, 137, 126, 113,
                          175, 26, 50, 119, 147, 137, 21, 54, 104, 81, 75, 196, 42, 102, 83, 141, 231, 68, 114, 81, 225, 68, 26, 177, 172, 195, 210, 141, 172, 128, 109, 121,
                          210, 176, 62, 45, 190, 79, 61, 12, 74, 187, 133, 142, 51, 92, 193, 51, 141, 56, 102, 177, 180, 29, 73, 206, 186, 182, 132, 85, 153, 139, 140, 105,
                          96, 95, 7, 109, 82, 99, 131, 85, 135, 170, 115, 124, 92, 158, 109, 144, 155, 72, 77, 85, 80, 125, 226, 192, 78, 207, 181, 155, 69, 204, 221, 107,
                          178, 31, 46, 112, 147, 131, 17, 46, 106, 74, 89, 210, 48, 95, 104, 123, 224, 68, 112, 96, 226, 62, 19, 192, 161, 194, 209, 133, 161, 139, 124, 119,
};


unordered_map<string, vector<long>> mp2;
unordered_set<long> p_set;
void FinsP(const char *sax_filename) {
    FILE * data_file = fopen(sax_filename,"r");
    if (!data_file) {
        cout << "" << sax_filename << endl;
        exit(-1);
    }
    vector<SAX> sax_vec(TOTAL_TS);

    for(int i = 0; i < TOTAL_TS; i++) {
        fread(&sax_vec[i], sizeof(SAX), 1, data_file);

        bool flag = true;
        for (int j = 0; j < deep_sax_len; j ++ ) {
            if (deep_sax[j] == sax_vec[i]) {
                string str;
                for (int j = 0; j < SEGMENTS; j ++ ) {
                    str += to_string(sax_vec[i].sax[j]);
                    str += ", ";
                }
                mp2[str].emplace_back(i);
            }
        }
    }
    for (auto& s: mp2) {
        cout << s.first << endl;
        // 09899ï¼Œ
        for (int i = 99; i < s.second.size(); i ++ ) {
            p_set.insert(s.second[i]);
        }
    }
    cout << p_set.size() << endl;
    fclose (data_file);
}

void DeleteDeep(const char *filename) {
    FILE * data_file = fopen(filename,"r");
    if (!data_file) {
        cout << "" << filename << endl;
        exit(-1);
    }


    FILE * new_ts_file = fopen("../../dataset/new_deep1b.bin", "wb");
    FILE * new_sax_file = fopen("../../dataset/new_deep1b_sax.bin", "wb");

    TS ts;
    for (int i = 0; i < TOTAL_TS; i ++ ) {
        fread(&ts, sizeof(ts), 1, data_file);
        if (p_set.count(i)) {
            continue;
        }
        fwrite(&ts, sizeof(ts), 1, new_ts_file);
        SAX sax;
        sax_from_ts(ts.ts, sax.sax);
        fwrite(&sax, sizeof(sax), 1, new_sax_file);

        if ((i + 1) % 1000000 == 0) {
            cout << i + 1 << endl;
        }
    }
}


int main() {
//    const char *filename = "../../dataset/deep1b_99974688.bin2";
    const char *filename = "../../dataset/ts.bin1";
//    const char *sax_filename = "../../dataset/deep1b_sax_99974688.bin2";
    const char *sax_filename = "../../dataset/ts_sax.bin1";
    const char *query_filename = "../../dataset/deep1b_query_ori.bin";
    const char *bsax_answer_filename = "../../dataset_answers/deep1b_bbinary_bsax.bin";
    const char *isax_answer_filename = "../../dataset_answers/deep1b_bbinary_isax.bin";

//    FinsSAX(sax_filename);
    FinsP(sax_filename);
    DeleteDeep(filename);
}